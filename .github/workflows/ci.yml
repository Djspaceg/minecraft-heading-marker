name: Minecraft Mod CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  unit-test:
    name: Unit Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
    
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle
    
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
    
      - name: Run unit tests
        run: ./gradlew test --stacktrace
    
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            build/reports/tests/
            build/test-results/
          retention-days: 14

  build:
    name: Build Mod
    runs-on: ubuntu-latest
    needs: [unit-test]
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
    
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle
    
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
    
      - name: Build mod
        run: ./gradlew build --stacktrace
    
      - name: Upload mod JAR
        uses: actions/upload-artifact@v4
        with:
          name: headingmarker-mod
          path: build/libs/*.jar
          retention-days: 30

  status-report:
    name: Status Report
    runs-on: ubuntu-latest
    needs: [unit-test, build]
    if: always() && github.event_name == 'pull_request'
    permissions:
      contents: read
      issues: write
      pull-requests: write
      actions: read
    
    steps:
      - name: Comment on PR with artifact links
        uses: actions/github-script@v7
        with:
          script: |
            const runId = context.runId;
            
            try {
              // Poll for artifacts with retries
              let artifacts = null;
              for (let attempt = 0; attempt < 10; attempt++) {
                const result = await github.rest.actions.listWorkflowRunArtifacts({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  run_id: runId
                });
                
                if (result.data.artifacts.length > 0) {
                  artifacts = result.data.artifacts;
                  break;
                }
                
                // Wait before retrying
                await new Promise(resolve => setTimeout(resolve, 2000));
              }
              
              // Only post comment if artifacts were found
              if (!artifacts || artifacts.length === 0) {
                console.log('No artifacts found after polling');
                return;
              }
              
              // Build artifact links
              let artifactLinks = [];
              for (const artifact of artifacts) {
                const downloadUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}/artifacts/${artifact.id}`;
                artifactLinks.push(`- [${artifact.name}](${downloadUrl})`);
              }
              
              const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;
              const comment = 'ðŸ“¦ **Build complete** â€” [View workflow run](' + runUrl + ')\n\n' + artifactLinks.join('\n');
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (error) {
              console.error('Failed to post PR comment with artifact links:', error);
              // Do not rethrow; this step is non-critical and should not fail the CI job.
            }