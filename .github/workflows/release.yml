name: Build Release Mod

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
    
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle
    
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
    
      - name: Build release mod
        run: ./gradlew build --stacktrace
    
      - name: Get version info
        id: version
        run: |
          # Get version from gradle.properties
          VERSION=$(grep '^mod_version=' gradle.properties | cut -d'=' -f2)
          if [ -z "$VERSION" ]; then
            echo "Error: Failed to extract version"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # Find the mod JAR file (exclude sources jar)
          JAR_FILES=(build/libs/*[0-9].jar)
          JAR_COUNT=${#JAR_FILES[@]}
          if [ "$JAR_COUNT" -lt 1 ]; then
            echo "Error: No JAR files found"
            ls -la build/libs/
            exit 1
          fi
          # Use the first JAR file (should be the main mod jar)
          echo "jar_path=${JAR_FILES[0]}" >> $GITHUB_OUTPUT
          echo "jar_name=$(basename ${JAR_FILES[0]})" >> $GITHUB_OUTPUT
    
      - name: Upload release mod
        uses: actions/upload-artifact@v4
        with:
          name: headingmarker-${{ steps.version.outputs.version }}
          path: build/libs/*.jar
          retention-days: 90
    
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: build/libs/*.jar
          body: |
            Release of Heading Marker mod v${{ steps.version.outputs.version }}
            
            **Installation:**
            1. Download the JAR file
            2. Place it in your Minecraft `mods` folder
            3. Make sure you have Fabric Loader installed
            4. Launch Minecraft 1.21.11
            
            **Requirements:**
            - Minecraft 1.21.11
            - Fabric Loader 0.18.2+
            - Fabric API 0.140.2+
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}